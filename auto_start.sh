#!/bin/bash

# ะะฒัะพะผะฐัะธัะตัะบะธะน ะทะฐะฟััะบ Baz Car API ั ะธัะฟัะฐะฒะปะตะฝะธัะผะธ

echo "๐ ะะฒัะพะผะฐัะธัะตัะบะธะน ะทะฐะฟััะบ Baz Car API..."

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ััะฐััะน ัะตัะฒะตั
echo "๐ ะััะฐะฝะพะฒะบะฐ ััะฐัะพะณะพ ัะตัะฒะตัะฐ..."
pkill -f uvicorn || true
sleep 2

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต Python3
if ! command -v python3 &> /dev/null; then
    echo "โ ะัะธะฑะบะฐ: python3 ะฝะต ัััะฐะฝะพะฒะปะตะฝ"
    exit 1
fi

echo "โ Python3 ะฝะฐะนะดะตะฝ: $(python3 --version)"

# ะฃะดะฐะปัะตะผ ััะฐัะพะต ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต ะตัะปะธ ะตััั
if [ -d "venv" ]; then
    echo "๐๏ธ  ะฃะดะฐะปะตะฝะธะต ััะฐัะพะณะพ ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
    rm -rf venv
fi

# ะกะพะทะดะฐะตะผ ะฝะพะฒะพะต ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต
echo "๐ฆ ะกะพะทะดะฐะฝะธะต ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
python3 -m venv venv

# ะัะพะฒะตััะตะผ, ััะพ ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต ัะพะทะดะฐะปะพัั
if [ ! -d "venv" ]; then
    echo "โ ะัะธะฑะบะฐ: ะฝะต ัะดะฐะปะพัั ัะพะทะดะฐัั ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต"
    echo "๐ก ะะพะฟัะพะฑัะนัะต ัััะฐะฝะพะฒะธัั: apt install python3.12-venv"
    exit 1
fi

# ะะบัะธะฒะธััะตะผ ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต
echo "๐ง ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
source venv/bin/activate

# ะะฑะฝะพะฒะปัะตะผ pip
echo "โฌ๏ธ  ะะฑะฝะพะฒะปะตะฝะธะต pip..."
pip install --upgrade pip

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ
echo "๐ฅ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
pip install -r requirements.txt

# ะัะพะฒะตััะตะผ, ััะพ uvicorn ัััะฐะฝะพะฒะธะปัั
if [ ! -f "venv/bin/uvicorn" ]; then
    echo "โ ะัะธะฑะบะฐ: uvicorn ะฝะต ัััะฐะฝะพะฒะปะตะฝ"
    exit 1
fi

# ะัะธะผะตะฝัะตะผ ะธัะฟัะฐะฒะปะตะฝะธั CORS ะธ cookies
echo "๐ง ะัะธะผะตะฝะตะฝะธะต ะธัะฟัะฐะฒะปะตะฝะธะน..."
if [ -f "app/core/config_fixed.py" ]; then
    cp app/core/config_fixed.py app/core/config.py
    echo "โ ะะฐัััะพะนะบะธ CORS ะพะฑะฝะพะฒะปะตะฝั"
fi

if [ -f "app/api/v1/endpoints/auth_fixed.py" ]; then
    cp app/api/v1/endpoints/auth_fixed.py app/api/v1/endpoints/auth.py
    echo "โ ะะฐัััะพะนะบะธ cookies ะพะฑะฝะพะฒะปะตะฝั"
fi

# ะฃะดะฐะปัะตะผ ะฒัะตะผะตะฝะฝัะต ัะฐะนะปั
rm -f app/core/config_fixed.py
rm -f app/api/v1/endpoints/auth_fixed.py

# ะกะพะทะดะฐะตะผ ะดะธัะตะบัะพัะธะธ
echo "๐ ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะน..."
mkdir -p uploads/temp
mkdir -p uploads/cars

# ะัะพะฒะตััะตะผ ะฟัะฐะฒะฐ ะดะพัััะฟะฐ
chmod 755 uploads
chmod 755 uploads/temp
chmod 755 uploads/cars

# ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั ะฝะฐ ะฟะพััั 8080
echo "โ ะะฐะฟััะบ ัะตัะฒะตัะฐ ะฝะฐ ะฟะพััั 8080..."
nohup venv/bin/uvicorn main:app --host 0.0.0.0 --port 8080 > server.log 2>&1 &

# ะกะพััะฐะฝัะตะผ PID
SERVER_PID=$!
echo $SERVER_PID > server.pid

# ะะดะตะผ ะฝะตะผะฝะพะณะพ ะธ ะฟัะพะฒะตััะตะผ, ััะพ ัะตัะฒะตั ะทะฐะฟัััะธะปัั
sleep 3

if ps -p $SERVER_PID > /dev/null; then
    echo "โ ะกะตัะฒะตั ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ!"
    echo "๐ API ะดะพัััะฟะตะฝ: http://91.229.8.235:8080/"
    echo "๐ ะะพะบัะผะตะฝัะฐัะธั: http://91.229.8.235:8080/docs"
    echo "๐ ะะฒัะพัะธะทะฐัะธั: http://91.229.8.235:8080/api/v1/auth/login"
    echo "๐ ะะพะณะธ: tail -f server.log"
    echo "๐ ะััะฐะฝะพะฒะบะฐ: kill $SERVER_PID"
    echo ""
    echo "๐ PID ัะตัะฒะตัะฐ: $SERVER_PID"
else
    echo "โ ะัะธะฑะบะฐ: ัะตัะฒะตั ะฝะต ะทะฐะฟัััะธะปัั. ะัะพะฒะตัััะต ะปะพะณะธ: cat server.log"
    exit 1
fi
