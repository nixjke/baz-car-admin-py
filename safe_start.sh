#!/bin/bash

# ะะตะทะพะฟะฐัะฝัะน ะทะฐะฟััะบ Baz Car API ั ะฐะฒัะพะผะฐัะธัะตัะบะธะผะธ ะผะธะณัะฐัะธัะผะธ
# ะญัะพั ัะบัะธะฟั ะณะฐัะฐะฝัะธััะตั, ััะพ ะดะฐะฝะฝัะต ะฝะต ะฑัะดัั ะฟะพัะตััะฝั ะฟัะธ ะพะฑะฝะพะฒะปะตะฝะธะธ

echo "๐ ะะตะทะพะฟะฐัะฝัะน ะทะฐะฟััะบ Baz Car API"
echo "================================"

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ััะฐััะน ัะตัะฒะตั ะตัะปะธ ะพะฝ ะทะฐะฟััะตะฝ
echo "๐ ะัะพะฒะตัะบะฐ ะทะฐะฟััะตะฝะฝัั ะฟัะพัะตััะพะฒ..."
if [ -f "server.pid" ]; then
    OLD_PID=$(cat server.pid)
    if ps -p $OLD_PID > /dev/null 2>&1; then
        echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ััะฐััะน ัะตัะฒะตั (PID: $OLD_PID)..."
        kill $OLD_PID
        sleep 2
    fi
    rm -f server.pid
fi

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต Python3
if ! command -v python3 &> /dev/null; then
    echo "โ ะัะธะฑะบะฐ: python3 ะฝะต ัััะฐะฝะพะฒะปะตะฝ"
    exit 1
fi

echo "โ Python3 ะฝะฐะนะดะตะฝ: $(python3 --version)"

# ะัะพะฒะตััะตะผ ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต
if [ ! -d "venv" ]; then
    echo "๐ฆ ะกะพะทะดะฐะฝะธะต ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
    python3 -m venv venv
fi

# ะะบัะธะฒะธััะตะผ ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต
echo "๐ง ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
source venv/bin/activate

# ะะฑะฝะพะฒะปัะตะผ pip
echo "โฌ๏ธ  ะะฑะฝะพะฒะปะตะฝะธะต pip..."
pip install --upgrade pip

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ
echo "๐ฅ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
pip install -r requirements.txt

# ะกะพะทะดะฐะตะผ ะฝะตะพะฑัะพะดะธะผัะต ะดะธัะตะบัะพัะธะธ
echo "๐ ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะน..."
mkdir -p uploads/temp
mkdir -p uploads/cars
mkdir -p migrations

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะฐะฒะฐ ะดะพัััะฟะฐ
chmod 755 uploads
chmod 755 uploads/temp
chmod 755 uploads/cars

# ะะะะะ: ะัะฟะพะปะฝัะตะผ ะฐะฒัะพะผะฐัะธัะตัะบะธะต ะผะธะณัะฐัะธะธ
echo ""
echo "๐ง ะัะฟะพะปะฝะตะฝะธะต ะฐะฒัะพะผะฐัะธัะตัะบะธั ะผะธะณัะฐัะธะน..."
echo "   ะญัะพ ะณะฐัะฐะฝัะธััะตั, ััะพ ะดะฐะฝะฝัะต ะฝะต ะฑัะดัั ะฟะพัะตััะฝั"
echo ""

./auto_migrate.sh

MIGRATION_EXIT_CODE=$?

if [ $MIGRATION_EXIT_CODE -ne 0 ]; then
    echo ""
    echo "โ ะัะธัะธัะตัะบะฐั ะพัะธะฑะบะฐ: ะผะธะณัะฐัะธะธ ะฝะต ะฒัะฟะพะปะฝะตะฝั!"
    echo "   ะกะตัะฒะตั ะฝะต ะฑัะดะตั ะทะฐะฟััะตะฝ ะดะปั ะทะฐัะธัั ะดะฐะฝะฝัั"
    echo "   ะัะพะฒะตัััะต ะปะพะณะธ ะผะธะณัะฐัะธะน ะฒััะต"
    exit 1
fi

echo ""
echo "โ ะะธะณัะฐัะธะธ ะฒัะฟะพะปะฝะตะฝั ััะฟะตัะฝะพ!"
echo ""

# ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั
echo "๐ ะะฐะฟััะบ ัะตัะฒะตัะฐ ะฝะฐ ะฟะพััั 8080..."

# ะะฟัะตะดะตะปัะตะผ ะฟะพัั
PORT=${PORT:-8080}

# ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั ะฒ ัะพะฝะต
nohup venv/bin/uvicorn main:app --host 0.0.0.0 --port $PORT --reload > server.log 2>&1 &

# ะกะพััะฐะฝัะตะผ PID
SERVER_PID=$!
echo $SERVER_PID > server.pid

# ะะดะตะผ ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ
echo "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ..."
sleep 3

# ะัะพะฒะตััะตะผ, ััะพ ัะตัะฒะตั ะทะฐะฟัััะธะปัั
if ps -p $SERVER_PID > /dev/null; then
    echo ""
    echo "๐ ะกะตัะฒะตั ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ!"
    echo "================================"
    echo "๐ API: http://localhost:$PORT/"
    echo "๐ ะะพะบัะผะตะฝัะฐัะธั: http://localhost:$PORT/docs"
    echo "๐ ะะฒัะพัะธะทะฐัะธั: http://localhost:$PORT/api/v1/auth/login"
    echo "๐ ะะพะณะธ: tail -f server.log"
    echo "๐ ะััะฐะฝะพะฒะบะฐ: kill $SERVER_PID"
    echo ""
    echo "๐ PID ัะตัะฒะตัะฐ: $SERVER_PID"
    echo ""
    echo "โ ะะฐะทะฐ ะดะฐะฝะฝัั ะพะฑะฝะพะฒะปะตะฝะฐ ะฑะตะทะพะฟะฐัะฝะพ"
    echo "โ ะัะต ะดะฐะฝะฝัะต ัะพััะฐะฝะตะฝั"
    echo "โ ะกะตัะฒะตั ะณะพัะพะฒ ะบ ัะฐะฑะพัะต"
else
    echo ""
    echo "โ ะัะธะฑะบะฐ: ัะตัะฒะตั ะฝะต ะทะฐะฟัััะธะปัั"
    echo "   ะัะพะฒะตัััะต ะปะพะณะธ: cat server.log"
    exit 1
fi
